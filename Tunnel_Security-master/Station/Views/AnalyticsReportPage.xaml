<Page
    x:Class="Station.Views.AnalyticsReportPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
	    xmlns:lvc="using:LiveChartsCore.SkiaSharpView.WinUI"

    mc:Ignorable="d">

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
          Padding="16">

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- ====== TOP BAR ====== -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <Button Click="BackButton_Click"
                        Margin="0,0,12,0"
                        Style="{StaticResource NavigationBackButtonNormalStyle}">
                    <FontIcon Glyph="&#xE72B;"/>
                </Button>

                <StackPanel>
                    <TextBlock Text="Báo cáo"
                               FontSize="22"
                               FontWeight="SemiBold"
                               Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                    <TextBlock Text="Trạm Nghĩa Đô · TRM-HN-001"
                               FontSize="13"
                               Opacity="0.7"/>
                </StackPanel>
            </StackPanel>

            <!-- Bộ lọc thời gian / khu vực -->
            <StackPanel Grid.Column="1"
                        Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="8">
                <ComboBox Width="160"
                          Header="Khoảng thời gian"
                          SelectedIndex="1">
                    <ComboBoxItem Content="Hôm nay"/>
                    <ComboBoxItem Content="7 ngày qua"/>
                    <ComboBoxItem Content="30 ngày qua"/>
                    <ComboBoxItem Content="Tuỳ chọn…"/>
                </ComboBox>

                <ComboBox Width="140"
                          Header="Tuyến">
                    <ComboBoxItem Content="Tất cả tuyến"/>
                    <ComboBoxItem Content="Tuyến 1"/>
                    <ComboBoxItem Content="Tuyến 2"/>
                </ComboBox>

                <ComboBox Width="140"
                          Header="Mức cảnh báo">
                    <ComboBoxItem Content="Tất cả"/>
                    <ComboBoxItem Content="Thấp"/>
                    <ComboBoxItem Content="Trung bình"/>
                    <ComboBoxItem Content="Cao"/>
                    <ComboBoxItem Content="Nghiêm trọng"/>
                </ComboBox>
            </StackPanel>

            <!-- Nút export -->
            <StackPanel Grid.Column="2"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Spacing="8">
                <Button Content="Xuất PDF"
                        Click="ExportPdf_Click"/>
                <Button Content="Xuất Excel"
                        Click="ExportExcel_Click"/>
            </StackPanel>
        </Grid>

        <!-- ====== MAIN CONTENT ====== -->
		<Grid Grid.Row="1" Margin="0,12,0,0">
			<!-- Hàng 0: KPI, Hàng 1: 2 chart, Hàng 2: Lịch sử & Top node -->
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<!-- KPI -->
				<RowDefinition Height="*"/>
				<!-- 2 chart -->
				<RowDefinition Height="*"/>
				<!-- history + top node -->
			</Grid.RowDefinitions>

			<!-- 2 cột bằng nhau -->
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="*"/>
			</Grid.ColumnDefinitions>

			<!-- ================== KPI CARDS ================== -->
			<Grid Grid.Row="0" Grid.ColumnSpan="2">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="*"/>
				</Grid.ColumnDefinitions>

				<!-- Tổng số cảnh báo -->
				<Border Grid.Column="0"
						Margin="0,0,12,12"
						Background="{ThemeResource LayerFillColorDefaultBrush}"
						CornerRadius="12">
					<StackPanel Margin="16">
						<TextBlock Text="Tổng số cảnh báo"
								   FontSize="13"
								   Opacity="0.8"/>
						<TextBlock x:Name="TotalAlertsValue"
								   Text="0"
								   FontSize="24"
								   FontWeight="Bold"
								   Margin="0,4,0,0"/>
						<TextBlock x:Name="TotalAlertsChange"
								   Text="+0% so với kỳ trước"
								   FontSize="11"
								   Foreground="#FF35C97F"/>

						<!-- tỷ lệ đã xử lý / đang mở -->
						<TextBlock x:Name="ProcessedSummaryText"
								   Text="Đã xử lý: 0 (0%)"
								   FontSize="11"
								   Margin="0,4,0,0"/>
						<TextBlock x:Name="OpenSummaryText"
								   Text="Đang mở: 0 (0%)"
								   FontSize="11"/>
					</StackPanel>
				</Border>

				<!-- Cảnh báo nghiêm trọng -->
				<Border Grid.Column="1"
						Margin="0,0,12,12"
						Background="{ThemeResource LayerFillColorDefaultBrush}"
						CornerRadius="12">
					<StackPanel Margin="16">
						<TextBlock Text="Cảnh báo nghiêm trọng"
								   FontSize="13"
								   Opacity="0.8"/>
						<TextBlock x:Name="SevereAlertsValue"
								   Text="9"
								   FontSize="24"
								   FontWeight="Bold"
								   Margin="0,4,0,0"/>
						<TextBlock x:Name="SevereAlertsChange"
								   Text="-3 so với kỳ trước"
								   FontSize="11"
								   Foreground="#FF35C97F"/>

						<TextBlock x:Name="LineCountText"
								   Text="Số tuyến có cảnh báo: 0"
								   FontSize="11"
								   Margin="0,4,0,0"/>
					</StackPanel>
				</Border>

				<!-- Node lỗi nhiều nhất -->
				<Border Grid.Column="2"
						Margin="0,0,12,12"
						Background="{ThemeResource LayerFillColorDefaultBrush}"
						CornerRadius="12">
					<StackPanel Margin="16">
						<TextBlock Text="Node lỗi nhiều nhất"
								   FontSize="13"
								   Opacity="0.8"/>
						<TextBlock Text="SEN-002"
								   FontSize="20"
								   FontWeight="Bold"
								   Margin="0,4,0,0"/>
						<TextBlock Text="23 cảnh báo"
								   FontSize="11"/>
					</StackPanel>
				</Border>

				<!-- Thiết bị hoạt động -->
				<Border Grid.Column="3"
						Margin="0,0,0,12"
						Background="{ThemeResource LayerFillColorDefaultBrush}"
						CornerRadius="12">
					<StackPanel Margin="16">
						<TextBlock Text="Thiết bị đang online"
								   FontSize="13"
								   Opacity="0.8"/>
						<TextBlock x:Name="OnlineDeviceText"
								   Text="39 / 45"
								   FontSize="24"
								   FontWeight="Bold"
								   Margin="0,4,0,0"/>
						<TextBlock Text="86% hoạt động"
								   FontSize="11"/>

						<TextBlock x:Name="AvgHandleTimeText"
								   Text="Thời gian xử lý TB: -"
								   FontSize="11"
								   Margin="0,4,0,0"/>
					</StackPanel>
				</Border>
			</Grid>

			<!-- ========== HÀNG 1: 2 BIỂU ĐỒ ========== -->

			<!-- Xu hướng cảnh báo theo tuyến: R1C0 -->
			<Border Grid.Row="1"
					Grid.Column="0"
					Margin="0,0,12,12"
					Background="{ThemeResource LayerFillColorDefaultBrush}"
					CornerRadius="12">
				<StackPanel Margin="16">
					<TextBlock Text="Xu hướng cảnh báo theo tuyến"
							   FontSize="16"
							   FontWeight="SemiBold"
							   Margin="0,0,0,4"/>
					<TextBlock Text="(Biểu đồ đường hoặc cột – binding với dữ liệu tuyến)"
							   FontSize="11"
							   Opacity="0.6"/>

					<lvc:CartesianChart Margin="0,12,0,0"
										Height="180"
										Series="{x:Bind AlertsByLineSeries}"
										XAxes="{x:Bind LineAxes}"
										YAxes="{x:Bind LineYAxes}"/>
				</StackPanel>
			</Border>

			<!-- Xu hướng theo thời gian trong ngày: R1C1 -->
			<Border Grid.Row="1"
					Grid.Column="1"
					Margin="0,0,0,12"
					Background="{ThemeResource LayerFillColorDefaultBrush}"
					CornerRadius="12">
				<StackPanel Margin="16">
					<TextBlock Text="Xu hướng theo thời gian trong ngày"
							   FontSize="16"
							   FontWeight="SemiBold"
							   Margin="0,0,0,4"/>

					<lvc:CartesianChart Margin="0,8,0,0"
										Height="180"
										Series="{x:Bind AlertsByHourSeries}"
										XAxes="{x:Bind HourAxes}"
										YAxes="{x:Bind HourYAxes}"/>
				</StackPanel>
			</Border>

			<!-- ========== HÀNG 2: LỊCH SỬ & TOP NODE ========== -->

			<!-- Lịch sử cảnh báo: R2C0 -->
			<Border Grid.Row="2"
					Grid.Column="0"
					Margin="0,0,12,0"
					Background="{ThemeResource LayerFillColorDefaultBrush}"
					CornerRadius="12">
				<StackPanel Margin="16">
					<StackPanel Orientation="Horizontal"
								HorizontalAlignment="Stretch">
						<TextBlock Text="Dữ liệu lịch sử cảnh báo"
								   FontSize="16"
								   FontWeight="SemiBold"/>

						<Button Content="Lọc nâng cao"
								Margin="12,0,0,0"
								HorizontalAlignment="Right"/>
					</StackPanel>

					<ListView x:Name="HistoryGrid"
							  Margin="0,12,0,0"
							  IsItemClickEnabled="False">

						<ListView.Header>
							<Grid Padding="0,0,0,4">
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="160"/>
									<!-- Thời gian -->
									<ColumnDefinition Width="80"/>
									<!-- Tuyến -->
									<ColumnDefinition Width="120"/>
									<!-- Nút -->
									<ColumnDefinition Width="200"/>
									<!-- Loại cảnh báo -->
									<ColumnDefinition Width="100"/>
									<!-- Mức độ -->
									<ColumnDefinition Width="160"/>
									<!-- Trạng thái xử lý -->
								</Grid.ColumnDefinitions>

								<TextBlock Grid.Column="0" Text="Thời gian"          FontWeight="SemiBold"/>
								<TextBlock Grid.Column="1" Text="Tuyến"              FontWeight="SemiBold"/>
								<TextBlock Grid.Column="2" Text="Nút"                FontWeight="SemiBold"/>
								<TextBlock Grid.Column="3" Text="Loại cảnh báo"      FontWeight="SemiBold"/>
								<TextBlock Grid.Column="4" Text="Mức độ"             FontWeight="SemiBold"/>
								<TextBlock Grid.Column="5" Text="Trạng thái xử lý"   FontWeight="SemiBold"/>
							</Grid>
						</ListView.Header>

						<ListView.ItemTemplate>
							<DataTemplate>
								<Grid Padding="0,4,0,4">
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="160"/>
										<ColumnDefinition Width="80"/>
										<ColumnDefinition Width="120"/>
										<ColumnDefinition Width="200"/>
										<ColumnDefinition Width="100"/>
										<ColumnDefinition Width="160"/>
									</Grid.ColumnDefinitions>

									<TextBlock Grid.Column="0" Text="{Binding Timestamp}"/>
									<TextBlock Grid.Column="1" Text="{Binding Line}"/>
									<TextBlock Grid.Column="2" Text="{Binding Node}"/>
									<TextBlock Grid.Column="3" Text="{Binding AlertType}"/>
									<TextBlock Grid.Column="4" Text="{Binding Severity}"/>
									<TextBlock Grid.Column="5" Text="{Binding Status}"/>
								</Grid>
							</DataTemplate>
						</ListView.ItemTemplate>
					</ListView>
				</StackPanel>
			</Border>

			<!-- Top node lỗi nhiều nhất: R2C1 -->
			<Border Grid.Row="2"
					Grid.Column="1"
					Background="{ThemeResource LayerFillColorDefaultBrush}"
					CornerRadius="12">
				<StackPanel Margin="16">
					<TextBlock Text="Top node lỗi nhiều nhất"
							   FontSize="16"
							   FontWeight="SemiBold"
							   Margin="0,0,0,8"/>

					<ListView x:Name="TopNodeList">
						<ListView.ItemTemplate>
							<DataTemplate>
								<Grid Margin="0,4">
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="Auto"/>
										<ColumnDefinition Width="*"/>
										<ColumnDefinition Width="Auto"/>
									</Grid.ColumnDefinitions>

									<TextBlock Grid.Column="0"
											   Text="{Binding Rank}"
											   FontWeight="SemiBold"
											   Width="20"/>

									<StackPanel Grid.Column="1">
										<TextBlock Text="{Binding NodeCode}"
												   FontWeight="SemiBold"/>
										<TextBlock Text="{Binding LineName}"
												   FontSize="11"
												   Opacity="0.7"/>
									</StackPanel>

									<TextBlock Grid.Column="2"
											   Text="{Binding AlertCount}"
											   FontWeight="SemiBold"/>
								</Grid>
							</DataTemplate>
						</ListView.ItemTemplate>
					</ListView>
				</StackPanel>
			</Border>
		</Grid>

	</Grid>
</Page>
