<Page
    x:Class="Station.Views.AnalyticsReportPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:lvc="using:LiveChartsCore.SkiaSharpView.WinUI"
    mc:Ignorable="d">

    <!-- =================== RESOURCES =================== -->
    <Page.Resources>
        <Style x:Key="AnalyticsKpiCardBorderStyle" TargetType="Border">
            <!-- Nền hơi sáng hơn background chung để nhìn nổi lên -->
            <Setter Property="Background" Value="{StaticResource AnalyticsKpiBackgroundBrush}"/>
            <Setter Property="CornerRadius" Value="18"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Margin" Value="0,4,12,16"/>
        </Style>

        <SolidColorBrush x:Key="AnalyticsKpiBackgroundBrush" Color="#111827"/>
        <SolidColorBrush x:Key="AnalyticsKpiBorderBrush"     Color="#2563EB"/>

        <!-- Nền & card: đồng bộ với MonitoringDashboard -->
        <SolidColorBrush x:Key="AnalyticsPageBackgroundBrush" Color="#050B1F"/>
        <SolidColorBrush x:Key="AnalyticsCardBackgroundBrush" Color="#0B1220"/>
        <SolidColorBrush x:Key="AnalyticsCardBorderBrush" Color="#111827"/>
        <SolidColorBrush x:Key="AnalyticsTextSecondaryBrush" Color="#9CA3AF"/>

        <!-- Màu cho nút lọc (nút xanh trên nền tối) -->
        <SolidColorBrush x:Key="FilterBlueBrush"                  Color="#4F8DFF"/>
        <SolidColorBrush x:Key="FilterBlueHoverBrush"             Color="#3F7DED"/>
        <SolidColorBrush x:Key="FilterBluePressedBrush"           Color="#305FCC"/>
        <SolidColorBrush x:Key="FilterDropDownBackgroundBrush"    Color="#050B1F"/>
        <SolidColorBrush x:Key="FilterDropDownItemHoverBrush"     Color="#111827"/>
        <SolidColorBrush x:Key="FilterDropDownItemSelectedBrush"  Color="#1D4ED8"/>

        <!-- Override brush mặc định của ComboBox chỉ trong page này -->
        <SolidColorBrush x:Key="ComboBoxBackground"                  Color="#4F8DFF"/>
        <SolidColorBrush x:Key="ComboBoxBackgroundPointerOver"       Color="#3F7DED"/>
        <SolidColorBrush x:Key="ComboBoxBackgroundPressed"           Color="#305FCC"/>
        <SolidColorBrush x:Key="ComboBoxBorderBrush"                 Color="#4F8DFF"/>
        <SolidColorBrush x:Key="ComboBoxBorderBrushPointerOver"      Color="#3F7DED"/>
        <SolidColorBrush x:Key="ComboBoxBorderBrushPressed"          Color="#305FCC"/>
        <SolidColorBrush x:Key="ComboBoxForeground"                  Color="White"/>
        <SolidColorBrush x:Key="ComboBoxDropDownBackground"          Color="#050B1F"/>

        <!-- Dropdown items -->
        <SolidColorBrush x:Key="ComboBoxItemForeground"                        Color="White"/>
        <SolidColorBrush x:Key="ComboBoxItemBackgroundPointerOver"            Color="#111827"/>
        <SolidColorBrush x:Key="ComboBoxItemBackgroundSelected"               Color="#1D4ED8"/>
        <SolidColorBrush x:Key="ComboBoxItemBackgroundSelectedPointerOver"    Color="#1E40AF"/>
        <SolidColorBrush x:Key="ComboBoxItemForegroundSelected"               Color="White"/>

        <!-- Style chung cho các ComboBox bộ lọc (hình pill xanh) -->
        <Style x:Key="AnalyticsFilterComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Margin" Value="0,0,12,0"/>
            <Setter Property="Padding" Value="20,8"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="MinWidth" Value="150"/>
            <!-- không đụng Template, dùng template mặc định + brush override -->
        </Style>

    </Page.Resources>

    <!-- =================== PAGE LAYOUT =================== -->
    <Grid Background="{StaticResource AnalyticsPageBackgroundBrush}"
          Padding="16">

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- ========= TOP BAR: Title + Export ========= -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <Button Click="BackButton_Click"
                        Margin="0,0,12,0"
                        Style="{StaticResource NavigationBackButtonNormalStyle}">
                    <FontIcon Glyph="&#xE72B;"/>
                </Button>

                <StackPanel>
                    <TextBlock Text="Phân tích và Báo cáo"
                               FontSize="22"
                               FontWeight="SemiBold"
                               Foreground="{ThemeResource TextPrimaryBrush}"/>
                    <TextBlock Text="Trạm Nghĩa Đô · TRM-HN-001"
                               FontSize="13"
                               Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                </StackPanel>
            </StackPanel>

            <!-- nút export -->
            <StackPanel Grid.Column="2"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Spacing="8">
                <Button Content="Xuất PDF"
                        Click="ExportPdf_Click"/>
                <Button Content="Xuất Excel"
                        Click="ExportExcel_Click"/>
            </StackPanel>
        </Grid>

        <!-- =================== MAIN CONTENT =================== -->
        <Grid Grid.Row="1" Margin="0,12,0,0">
            <!-- H0: KPI; H1: Filter; H2: 2 chart; H3: history + top node -->
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- ===== KPI CARDS ===== -->
            <Grid Grid.Row="0" Grid.ColumnSpan="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Tổng số cảnh báo -->
                <Border Grid.Column="0"
        Style="{StaticResource AnalyticsKpiCardBorderStyle}">
                    <StackPanel Margin="18">
                        <TextBlock Text="Tổng số cảnh báo"
                   FontSize="13"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                        <TextBlock x:Name="TotalAlertsValue"
                   Text="0"
                   FontSize="26"
                   FontWeight="Bold"
                   Foreground="{ThemeResource TextPrimaryBrush}"
                   Margin="0,6,0,0"/>
                        <TextBlock x:Name="TotalAlertsChange"
                   Text="+0% so với kỳ trước"
                   FontSize="11"
                   Foreground="#FF35C97F"
                   Margin="0,4,0,0"/>

                        <TextBlock x:Name="ProcessedSummaryText"
                   Text="Đã xử lý: 0 (0%)"
                   FontSize="11"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"
                   Margin="0,8,0,0"/>
                        <TextBlock x:Name="OpenSummaryText"
                   Text="Đang mở: 0 (0%)"
                   FontSize="11"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                    </StackPanel>
                </Border>


                <!-- Cảnh báo nghiêm trọng -->
                <Border Grid.Column="1"
        Style="{StaticResource AnalyticsKpiCardBorderStyle}">
                    <StackPanel Margin="18">
                        <TextBlock Text="Cảnh báo nghiêm trọng"
                   FontSize="13"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                        <TextBlock x:Name="SevereAlertsValue"
                   Text="9"
                   FontSize="26"
                   FontWeight="Bold"
                   Foreground="{ThemeResource TextPrimaryBrush}"
                   Margin="0,6,0,0"/>
                        <TextBlock x:Name="SevereAlertsChange"
                   Text="-3 so với kỳ trước"
                   FontSize="11"
                   Foreground="#FF35C97F"
                   Margin="0,4,0,0"/>

                        <TextBlock x:Name="LineCountText"
                   Text="Số tuyến có cảnh báo: 0"
                   FontSize="11"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"
                   Margin="0,8,0,0"/>
                    </StackPanel>
                </Border>



                <!-- Node lỗi nhiều nhất -->
                <Border Grid.Column="2"
        Style="{StaticResource AnalyticsKpiCardBorderStyle}">
                    <StackPanel Margin="18">
                        <TextBlock Text="Node lỗi nhiều nhất"
                   FontSize="13"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                        <TextBlock Text="SEN-002"
                   FontSize="22"
                   FontWeight="Bold"
                   Foreground="{ThemeResource TextPrimaryBrush}"
                   Margin="0,6,0,0"/>
                        <TextBlock Text="23 cảnh báo"
                   FontSize="11"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                    </StackPanel>
                </Border>



                <!-- Thiết bị hoạt động -->
                <Border Grid.Column="3"
        Style="{StaticResource AnalyticsKpiCardBorderStyle}">
                    <StackPanel Margin="18">
                        <TextBlock Text="Thiết bị đang online"
                   FontSize="13"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                        <TextBlock x:Name="OnlineDeviceText"
                   Text="39 / 45"
                   FontSize="26"
                   FontWeight="Bold"
                   Foreground="{ThemeResource TextPrimaryBrush}"
                   Margin="0,6,0,0"/>
                        <TextBlock Text="86% hoạt động"
                   FontSize="11"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>

                        <TextBlock x:Name="AvgHandleTimeText"
                   Text="Thời gian xử lý TB: -"
                   FontSize="11"
                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"
                   Margin="0,8,0,0"/>
                    </StackPanel>
                </Border>


            </Grid>

            <!-- ===== FILTER BAR (nút xanh) ===== -->
            <StackPanel Grid.Row="1"
                        Grid.ColumnSpan="2"
                        Orientation="Horizontal"
                        HorizontalAlignment="Left"
                        Spacing="8"
                        Margin="0,0,0,12">

                <!-- Mốc thời gian -->
                <ComboBox Style="{StaticResource AnalyticsFilterComboBoxStyle}"
                          SelectedIndex="0">
                    <ComboBoxItem Content="Hôm nay"/>
                    <ComboBoxItem Content="7 ngày qua"/>
                    <ComboBoxItem Content="30 ngày qua"/>
                    <ComboBoxItem Content="Tất cả thời gian"/>
                    <!-- Chú thích rõ hơn -->
                    <ComboBoxItem Content="Tuỳ chọn (chọn khoảng ngày…)"/>
                </ComboBox>

                <!-- Tuyến -->
                <ComboBox Style="{StaticResource AnalyticsFilterComboBoxStyle}"
                          SelectedIndex="0">
                    <ComboBoxItem Content="Tất cả tuyến"/>
                    <ComboBoxItem Content="Tuyến 1"/>
                    <ComboBoxItem Content="Tuyến 2"/>
                </ComboBox>

                <!-- Mức cảnh báo -->
                <ComboBox Style="{StaticResource AnalyticsFilterComboBoxStyle}"
                          SelectedIndex="0">
                    <ComboBoxItem Content="Tất cả mức độ"/>
                    <ComboBoxItem Content="Thấp"/>
                    <ComboBoxItem Content="Trung bình"/>
                    <ComboBoxItem Content="Cao"/>
                    <ComboBoxItem Content="Nghiêm trọng"/>
                </ComboBox>

                <!-- Trạng thái xử lý -->
                <ComboBox Style="{StaticResource AnalyticsFilterComboBoxStyle}"
                          SelectedIndex="0">
                    <ComboBoxItem Content="Tất cả trạng thái"/>
                    <ComboBoxItem Content="Đang xử lý"/>
                    <ComboBoxItem Content="Đã xử lý"/>
                    <ComboBoxItem Content="Bỏ qua"/>
                </ComboBox>
            </StackPanel>

            <!-- ===== HÀNG 2: 2 BIỂU ĐỒ ===== -->
            <!-- Xu hướng theo tuyến -->
            <Border Grid.Row="2"
                    Grid.Column="0"
                    Margin="0,0,12,12"
                    Background="{StaticResource AnalyticsCardBackgroundBrush}"
                    BorderBrush="{StaticResource AnalyticsCardBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="12">
                <StackPanel Margin="16">
                    <TextBlock Text="Xu hướng cảnh báo theo tuyến"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{ThemeResource TextPrimaryBrush}"
                               Margin="0,0,0,4"/>
                    <TextBlock Text="(Biểu đồ đường hoặc cột – binding với dữ liệu tuyến)"
                               FontSize="11"
                               Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>

                    <lvc:CartesianChart Margin="0,12,0,0"
                                        Height="180"
                                        Series="{x:Bind AlertsByLineSeries}"
                                        XAxes="{x:Bind LineAxes}"
                                        YAxes="{x:Bind LineYAxes}"/>
                </StackPanel>
            </Border>

            <!-- Xu hướng theo thời gian trong ngày -->
            <Border Grid.Row="2"
                    Grid.Column="1"
                    Margin="0,0,0,12"
                    Background="{StaticResource AnalyticsCardBackgroundBrush}"
                    BorderBrush="{StaticResource AnalyticsCardBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="12">
                <StackPanel Margin="16">
                    <TextBlock Text="Xu hướng theo thời gian trong ngày"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{ThemeResource TextPrimaryBrush}"
                               Margin="0,0,0,4"/>

                    <lvc:CartesianChart Margin="0,8,0,0"
                                        Height="180"
                                        Series="{x:Bind AlertsByHourSeries}"
                                        XAxes="{x:Bind HourAxes}"
                                        YAxes="{x:Bind HourYAxes}"/>
                </StackPanel>
            </Border>

            <!-- ===== HÀNG 3: LỊCH SỬ + TOP NODE ===== -->
            <!-- Lịch sử cảnh báo -->
            <Border Grid.Row="3"
                    Grid.Column="0"
                    Margin="0,0,12,0"
                    Background="{StaticResource AnalyticsCardBackgroundBrush}"
                    BorderBrush="{StaticResource AnalyticsCardBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="12">
                <StackPanel Margin="16">
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Stretch">
                        <TextBlock Text="Dữ liệu lịch sử cảnh báo"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="{ThemeResource TextPrimaryBrush}"/>

                        <Button Content="Lọc nâng cao"
                                Margin="12,0,0,0"
                                HorizontalAlignment="Right"/>
                    </StackPanel>

                    <ListView x:Name="HistoryGrid"
                              Margin="0,12,0,0"
                              IsItemClickEnabled="False">

                        <ListView.Header>
                            <Grid Padding="0,0,0,4">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="200"/>
                                    <ColumnDefinition Width="100"/>
                                    <ColumnDefinition Width="160"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0" Text="Thời gian" FontWeight="SemiBold"
                                           Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                                <TextBlock Grid.Column="1" Text="Tuyến"     FontWeight="SemiBold"
                                           Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                                <TextBlock Grid.Column="2" Text="Nút"       FontWeight="SemiBold"
                                           Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                                <TextBlock Grid.Column="3" Text="Loại cảnh báo" FontWeight="SemiBold"
                                           Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                                <TextBlock Grid.Column="4" Text="Mức độ"    FontWeight="SemiBold"
                                           Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                                <TextBlock Grid.Column="5" Text="Trạng thái xử lý" FontWeight="SemiBold"
                                           Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                            </Grid>
                        </ListView.Header>

                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="0,4,0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="160"/>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="200"/>
                                        <ColumnDefinition Width="100"/>
                                        <ColumnDefinition Width="160"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="{Binding Timestamp}"
                                               Foreground="{ThemeResource TextPrimaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Line}"
                                               Foreground="{ThemeResource TextPrimaryBrush}"/>
                                    <TextBlock Grid.Column="2" Text="{Binding Node}"
                                               Foreground="{ThemeResource TextPrimaryBrush}"/>
                                    <TextBlock Grid.Column="3" Text="{Binding AlertType}"
                                               Foreground="{ThemeResource TextPrimaryBrush}"/>
                                    <TextBlock Grid.Column="4" Text="{Binding Severity}"
                                               Foreground="{ThemeResource TextPrimaryBrush}"/>
                                    <TextBlock Grid.Column="5" Text="{Binding Status}"
                                               Foreground="{ThemeResource TextPrimaryBrush}"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>

            <!-- Top node lỗi nhiều nhất -->
            <Border Grid.Row="3"
                    Grid.Column="1"
                    Background="{StaticResource AnalyticsCardBackgroundBrush}"
                    BorderBrush="{StaticResource AnalyticsCardBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="12">
                <StackPanel Margin="16">
                    <TextBlock Text="Top node lỗi nhiều nhất"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{ThemeResource TextPrimaryBrush}"
                               Margin="0,0,0,8"/>

                    <ListView x:Name="TopNodeList">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0"
                                               Text="{Binding Rank}"
                                               FontWeight="SemiBold"
                                               Width="20"
                                               Foreground="{ThemeResource TextPrimaryBrush}"/>

                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="{Binding NodeCode}"
                                                   FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextPrimaryBrush}"/>
                                        <TextBlock Text="{Binding LineName}"
                                                   FontSize="11"
                                                   Foreground="{StaticResource AnalyticsTextSecondaryBrush}"/>
                                    </StackPanel>

                                    <TextBlock Grid.Column="2"
                                               Text="{Binding AlertCount}"
                                               FontWeight="SemiBold"
                                               Foreground="{ThemeResource TextPrimaryBrush}"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Page>
