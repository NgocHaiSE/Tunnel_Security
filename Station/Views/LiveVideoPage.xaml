<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Station.Views.LiveVideoPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:viewmodels="using:Station.ViewModels"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{StaticResource BackgroundSecondaryBrush}">

    <Page.Resources>
        <ThemeShadow x:Key="CommonShadow"/>
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Sidebar: Camera Selection -->
        <Border Grid.Column="0" Background="{StaticResource BackgroundPrimaryBrush}"
                BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="0,0,1,0">
            <Grid Padding="20,24">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Sidebar Header -->
                <StackPanel Grid.Row="0" Margin="0,0,0,24">
                    <TextBlock Text="Danh sách Camera" Style="{StaticResource TitleTextBlockStyle}" FontSize="20" Margin="0,0,0,4"/>
                    <TextBlock Text="Chọn camera để hiển thị" FontSize="13" Foreground="{StaticResource TextSecondaryBrush}"/>
                </StackPanel>

                <!-- Selection Actions -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8" Margin="0,0,0,16">
                    <Button x:Name="SelectAllButton" Content="Chọn tất cả"
                            Click="SelectAll_Click"
                            HorizontalAlignment="Stretch"
                            Style="{StaticResource SecondaryButtonStyle}" FontSize="12" Padding="12,6" MinHeight="32" Width="125"/>
                    <Button x:Name="DeselectAllButton" Content="Bỏ chọn"
                            Click="DeselectAll_Click"
                            HorizontalAlignment="Stretch"
                            Style="{StaticResource SecondaryButtonStyle}" FontSize="12" Padding="12,6" MinHeight="32" Width="125"/>
                </StackPanel>

                <!-- Camera List -->
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Padding="0,0,12,0">
                    <ItemsControl ItemsSource="{x:Bind ViewModel.CameraStreams, Mode=OneWay}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="viewmodels:CameraStreamViewModel">
                                <Border Background="Transparent" CornerRadius="8" Padding="12,8" Margin="0,0,0,4">
                                    <CheckBox IsChecked="{x:Bind IsSelected, Mode=TwoWay}" Padding="12,0,0,0">
                                        <StackPanel Orientation="Horizontal" Spacing="12">
                                            <Border Width="8" Height="8" CornerRadius="4" Background="{x:Bind StatusColor, Mode=OneWay}"/>
                                            <StackPanel>
                                                <TextBlock Text="{x:Bind CameraName}" FontSize="13" FontWeight="SemiBold" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                <TextBlock Text="{x:Bind CameraId}" FontSize="11" Foreground="{StaticResource TextTertiaryBrush}"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </CheckBox>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Column="1" Padding="24">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <Grid Grid.Row="0" Margin="0,0,0,24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Title & Stats -->
                <StackPanel Grid.Column="0">
                    <TextBlock Text="Giám sát Trực tiếp" Style="{StaticResource TitleTextBlockStyle}" Margin="0,0,0,8"/>
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <!-- Stat Badge -->
                        <Border Background="{StaticResource BackgroundPrimaryBrush}" CornerRadius="20" Padding="12,6"
                                BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE714;" FontSize="12" Foreground="{StaticResource SeverityLowBrush}"/>
                                <TextBlock FontSize="13">
                                    <Run Text="Hoạt động:" Foreground="{StaticResource TextSecondaryBrush}"/>
                                    <Run Text="{x:Bind ViewModel.ActiveCameras, Mode=OneWay}" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}"/>
                                    <Run Text="/" Foreground="{StaticResource TextTertiaryBrush}"/>
                                    <Run Text="{x:Bind ViewModel.TotalCameras, Mode=OneWay}" Foreground="{StaticResource TextTertiaryBrush}"/>
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <!-- Layout Info Badge -->
                        <Border Background="{StaticResource BackgroundPrimaryBrush}" CornerRadius="20" Padding="12,6"
                                BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE80A;" FontSize="12" Foreground="{StaticResource PrimaryMediumBrush}"/>
                                <TextBlock FontSize="13">
                                    <Run Text="Giao diện:" Foreground="{StaticResource TextSecondaryBrush}"/>
                                    <Run Text="{x:Bind ViewModel.SelectedLayoutText, Mode=OneWay}" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}"/>
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </StackPanel>

                <!-- Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Bottom">
                    <!-- Layout Selector -->
                    <Button Style="{StaticResource SecondaryButtonStyle}" ToolTipService.ToolTip="Thay đổi bố cục" Height="36" Padding="12,0">
                        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <FontIcon Glyph="&#xE80A;" FontSize="14"/>
                            <TextBlock Text="Bố cục" FontSize="13"/>
                            <FontIcon Glyph="&#xE70D;" FontSize="10" Opacity="0.6"/>
                        </StackPanel>
                        <Button.Flyout>
                            <MenuFlyout Placement="BottomEdgeAlignedRight">
                                <MenuFlyoutItem Text="1×1 - Đơn" Command="{x:Bind ViewModel.ChangeLayoutCommand}" CommandParameter="1">
                                    <MenuFlyoutItem.Icon><FontIcon Glyph="&#xE8A9;"/></MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem Text="2×2 - Lưới 4" Command="{x:Bind ViewModel.ChangeLayoutCommand}" CommandParameter="4">
                                    <MenuFlyoutItem.Icon><FontIcon Glyph="&#xE89A;"/></MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem Text="3×3 - Lưới 9" Command="{x:Bind ViewModel.ChangeLayoutCommand}" CommandParameter="9">
                                    <MenuFlyoutItem.Icon><FontIcon Glyph="&#xE80A;"/></MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem Text="4×4 - Lưới 16" Command="{x:Bind ViewModel.ChangeLayoutCommand}" CommandParameter="16">
                                    <MenuFlyoutItem.Icon><FontIcon Glyph="&#xE8FE;"/></MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                            </MenuFlyout>
                        </Button.Flyout>
                    </Button>

                    <!-- Refresh -->
                    <Button Style="{StaticResource SecondaryButtonStyle}" Command="{x:Bind ViewModel.RefreshStreamsCommand}"
                            ToolTipService.ToolTip="Làm mới" Height="36" Width="36" Padding="0">
                        <FontIcon Glyph="&#xE72C;" FontSize="14"/>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Video Grid -->
            <ScrollViewer Grid.Row="1" x:Name="VideoGridContainer" SizeChanged="VideoGridContainer_SizeChanged"
                          VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                <ItemsControl x:Name="CameraItemsControl" ItemsSource="{x:Bind ViewModel.CameraStreams, Mode=OneWay}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <ItemsWrapGrid Orientation="Horizontal"
                                           MaximumRowsOrColumns="{Binding ViewModel.GridColumns, ElementName=PageRoot, Mode=OneWay}"
                                           ItemWidth="{Binding ViewModel.CameraItemWidth, ElementName=PageRoot, Mode=OneWay}"
                                           ItemHeight="{Binding ViewModel.CameraItemHeight, ElementName=PageRoot, Mode=OneWay}"
                                           HorizontalAlignment="Left"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="viewmodels:CameraStreamViewModel">
                            <Grid Margin="0,0,16,16" Visibility="{x:Bind IsSelected, Mode=OneWay}">
                                <Border Background="{StaticResource BackgroundPrimaryBrush}"
                                        BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1"
                                        CornerRadius="12" Shadow="{StaticResource CommonShadow}">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <!-- Card Header -->
                                        <Grid Grid.Row="0" Padding="12,10" BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="0,0,0,1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                                <Border Width="8" Height="8" CornerRadius="4" Background="{x:Bind StatusColor, Mode=OneWay}"/>
                                                <TextBlock Text="{x:Bind CameraName}" FontSize="13" FontWeight="SemiBold" Foreground="{StaticResource TextPrimaryBrush}"/>
                                            </StackPanel>

                                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                                                <Button Style="{StaticResource IconButtonStyle}" Width="28" Height="28" Padding="4">
                                                    <FontIcon Glyph="&#xE713;" FontSize="12"/>
                                                </Button>
                                            </StackPanel>
                                        </Grid>

                                        <!-- Video Area -->
                                        <Grid Grid.Row="1" Background="Black" CornerRadius="0">
                                            <!-- Placeholder Pattern -->
                                            <Canvas>
                                                <Rectangle Width="2000" Height="2000" Canvas.Left="-500" Canvas.Top="-500" RenderTransformOrigin="0.5,0.5" Opacity="0.3">
                                                    <Rectangle.Fill>
                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1" SpreadMethod="Repeat">
                                                            <GradientStop Color="#0F0F0F" Offset="0"/>
                                                            <GradientStop Color="#0F0F0F" Offset="0.48"/>
                                                            <GradientStop Color="#2A2A2A" Offset="0.5"/>
                                                            <GradientStop Color="#2A2A2A" Offset="0.98"/>
                                                        </LinearGradientBrush>
                                                    </Rectangle.Fill>
                                                    <Rectangle.RenderTransform>
                                                        <RotateTransform Angle="45"/>
                                                    </Rectangle.RenderTransform>
                                                </Rectangle>
                                            </Canvas>

                                            <!-- Offline State -->
                                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8"
                                                        Visibility="{x:Bind IsOnline, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                                <FontIcon Glyph="&#xE7BA;" FontSize="32" Foreground="#525252"/>
                                                <TextBlock Text="Mất tín hiệu" FontSize="12" Foreground="#737373"/>
                                            </StackPanel>

                                            <!-- Overlays -->
                                            <StackPanel VerticalAlignment="Top" HorizontalAlignment="Right" Margin="8" Orientation="Horizontal" Spacing="4"
                                                        Visibility="{x:Bind IsOnline, Mode=OneWay}">
                                                <Border Background="#99000000" CornerRadius="4" Padding="6,2">
                                                    <TextBlock Text="LIVE" FontSize="10" FontWeight="Bold" Foreground="#EF4444"/>
                                                </Border>
                                                <Border Background="#99000000" CornerRadius="4" Padding="6,2" Visibility="{x:Bind IsRecording, Mode=OneWay}">
                                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                                        <FontIcon Glyph="&#xE7C8;" FontSize="8" Foreground="#EF4444" VerticalAlignment="Center"/>
                                                        <TextBlock Text="REC" FontSize="10" FontWeight="Bold" Foreground="White"/>
                                                    </StackPanel>
                                                </Border>
                                            </StackPanel>

                                            <Border VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="8"
                                                    Background="#99000000" CornerRadius="4" Padding="6,2"
                                                    Visibility="{x:Bind IsOnline, Mode=OneWay}">
                                                <TextBlock Text="{x:Bind BitrateDisplay, Mode=OneWay}" FontSize="10" Foreground="White"/>
                                            </Border>
                                        </Grid>

                                        <!-- Card Footer -->
                                        <Grid Grid.Row="2" Padding="12,8" Background="{StaticResource BackgroundSecondaryBrush}" CornerRadius="0,0,12,12">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Stats -->
                                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                                <Border Background="{StaticResource BackgroundPrimaryBrush}" CornerRadius="4" Padding="4,2" BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1">
                                                    <TextBlock Text="{x:Bind Resolution}" FontSize="10" Foreground="{StaticResource TextSecondaryBrush}" TextTrimming="CharacterEllipsis" MaxWidth="80"/>
                                                </Border>
                                                <Border Background="{StaticResource BackgroundPrimaryBrush}" CornerRadius="4" Padding="4,2" BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1">
                                                    <TextBlock FontSize="10" Foreground="{StaticResource TextSecondaryBrush}">
                                                        <Run Text="{x:Bind Fps, Mode=OneWay}"/>
                                                        <Run Text=" FPS"/>
                                                    </TextBlock>
                                                </Border>
                                            </StackPanel>

                                            <!-- Actions -->
                                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                                <Button Style="{StaticResource IconButtonStyle}" Width="28" Height="28" Padding="4"
                                                        Command="{Binding ElementName=PageRoot, Path=ViewModel.ToggleRecordingCommand}" CommandParameter="{Binding}"
                                                        ToolTipService.ToolTip="Ghi hình">
                                                    <FontIcon Glyph="{x:Bind RecordingIcon, Mode=OneWay}" Foreground="{x:Bind RecordingColor, Mode=OneWay}" FontSize="14"/>
                                                </Button>
                                                <Button Style="{StaticResource IconButtonStyle}" Width="28" Height="28" Padding="4"
                                                        Command="{Binding ElementName=PageRoot, Path=ViewModel.TakeSnapshotCommand}" CommandParameter="{Binding}"
                                                        ToolTipService.ToolTip="Chụp ảnh">
                                                    <FontIcon Glyph="&#xE722;" FontSize="14"/>
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Grid>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>
    </Grid>
</Page>