<Page
    x:Class="Station.Views.DevicesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Station.ViewModels"
    Background="{StaticResource BackgroundSecondaryBrush}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- Main Content (Left Column) -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header & Statistics Cards -->
            <Grid Grid.Row="0" Padding="24,20,24,16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="16" Margin="0,0,0,16">
                    <TextBlock Text="Quản lý Thiết bị"
                               FontSize="22" FontWeight="Bold"
                               Foreground="{StaticResource TextPrimaryBrush}"/>
                    <Border Background="{StaticResource BackgroundPrimaryBrush}"
                            CornerRadius="12" Padding="10,4" VerticalAlignment="Center"
                            BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1">
                        <TextBlock FontSize="13" FontWeight="Bold" Foreground="{StaticResource TextSecondaryBrush}">
                            <Run Text="{x:Bind ViewModel.TotalDevices, Mode=OneWay}"/>
                            <Run Text=" thiết bị"/>
                        </TextBlock>
                    </Border>
                </StackPanel>

                <!-- Statistics Cards -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Online -->
                    <Border Grid.Column="0" Background="{StaticResource BackgroundPrimaryBrush}" CornerRadius="12" Padding="16" Margin="0,0,8,0"
                            BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1">
                        <StackPanel Orientation="Horizontal" Spacing="14">
                            <Border Background="#DCFCE7" CornerRadius="10" Width="44" Height="44">
                                <FontIcon Glyph="&#xE73E;" FontSize="20" Foreground="#16A34A"
                                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <StackPanel VerticalAlignment="Center" Spacing="2">
                                <TextBlock Text="Hoạt động" FontSize="13" Foreground="{StaticResource TextSecondaryBrush}"/>
                                <TextBlock Text="{x:Bind ViewModel.OnlineDevices, Mode=OneWay}"
                                           FontSize="24" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Offline -->
                    <Border Grid.Column="1" Background="{StaticResource BackgroundPrimaryBrush}" CornerRadius="12" Padding="16" Margin="4,0"
                            BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1">
                        <StackPanel Orientation="Horizontal" Spacing="14">
                            <Border Background="#F1F5F9" CornerRadius="10" Width="44" Height="44">
                                <FontIcon Glyph="&#xE894;" FontSize="20" Foreground="#64748B"
                                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <StackPanel VerticalAlignment="Center" Spacing="2">
                                <TextBlock Text="Ngoại tuyến" FontSize="13" Foreground="{StaticResource TextSecondaryBrush}"/>
                                <TextBlock Text="{x:Bind ViewModel.OfflineDevices, Mode=OneWay}"
                                           FontSize="24" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Fault -->
                    <Border Grid.Column="2" Background="{StaticResource BackgroundPrimaryBrush}" CornerRadius="12" Padding="16" Margin="4,0"
                            BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1">
                        <StackPanel Orientation="Horizontal" Spacing="14">
                            <Border Background="#FEE2E2" CornerRadius="10" Width="44" Height="44">
                                <FontIcon Glyph="&#xE783;" FontSize="20" Foreground="#DC2626"
                                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <StackPanel VerticalAlignment="Center" Spacing="2">
                                <TextBlock Text="Lỗi" FontSize="13" Foreground="{StaticResource TextSecondaryBrush}"/>
                                <TextBlock Text="{x:Bind ViewModel.FaultDevices, Mode=OneWay}"
                                           FontSize="24" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>
            </Grid>

            <!-- Filter Bar -->
            <Border Grid.Row="1" Margin="24,0" Background="{StaticResource BackgroundPrimaryBrush}"
                    CornerRadius="10" BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1">
                <Grid Padding="16,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Search Box -->
                    <TextBox Grid.Column="0" PlaceholderText="Tìm kiếm thiết bị..."
                             Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             BorderThickness="0" Background="Transparent" FontSize="14"/>

                    <!-- Status Filter -->
                    <ComboBox Grid.Column="1" Width="160" Margin="12,0,0,0"
                              ItemsSource="{x:Bind ViewModel.StatusFilters}"
                              SelectedItem="{x:Bind ViewModel.SelectedStatus, Mode=TwoWay}"/>

                    <!-- Line Filter -->
                    <ComboBox Grid.Column="2" Width="140" Margin="12,0,0,0"
                              ItemsSource="{x:Bind ViewModel.LineFilters}"
                              SelectedItem="{x:Bind ViewModel.SelectedLine, Mode=TwoWay}"/>

                    <!-- Add Button -->
                    <Button Grid.Column="3" Style="{StaticResource PrimaryButtonStyle}" Margin="12,0,0,0"
                            Command="{x:Bind ViewModel.AddDeviceCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE710;" FontSize="14"/>
                            <TextBlock Text="Thêm thiết bị" FontSize="13"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>

            <!-- Devices List - Clickable Node Cards -->
            <Border Grid.Row="2" Margin="24,16,24,24"
                    Background="{StaticResource BackgroundSecondaryBrush}"
                    CornerRadius="12">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
                    <ItemsRepeater ItemsSource="{x:Bind ViewModel.FilteredNodes, Mode=OneWay}">
                        <ItemsRepeater.Layout>
                            <StackLayout Spacing="12"/>
                        </ItemsRepeater.Layout>
                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate>
                                <!-- Clickable Node Card -->
                                <Border Background="{StaticResource BackgroundPrimaryBrush}"
                                        BorderBrush="{StaticResource BorderLightBrush}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="16"
                                        PointerEntered="NodeCard_PointerEntered"
                                        PointerExited="NodeCard_PointerExited"
                                        Tapped="NodeCard_Tapped">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Node Icon -->
                                        <Border Grid.Column="0"
                                                Background="{StaticResource BackgroundAccentBrush}"
                                                CornerRadius="10"
                                                Width="52" Height="52"
                                                Margin="0,0,16,0">
                                            <FontIcon Glyph="&#xE968;" FontSize="24"
                                                      Foreground="{StaticResource PrimaryDarkBrush}"
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>

                                        <!-- Node Info -->
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                                            <TextBlock Text="{Binding NodeName}"
                                                       FontSize="16" FontWeight="Bold"
                                                       Foreground="{StaticResource TextPrimaryBrush}"/>
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock FontSize="13" Foreground="{StaticResource TextSecondaryBrush}">
                                                    <Run Text="{Binding LineName}"/>
                                                    <Run Text=" • "/>
                                                    <Run Text="{Binding Location}"/>
                                                </TextBlock>
                                            </StackPanel>
                                            <TextBlock Text="{Binding SensorCountText}"
                                                       FontSize="12" Foreground="{StaticResource TextTertiaryBrush}"/>
                                        </StackPanel>

                                        <!-- Status Badge -->
                                        <Border Grid.Column="2"
                                                Background="{Binding StatusBackgroundColor}"
                                                CornerRadius="6" Padding="10,6"
                                                VerticalAlignment="Center" Margin="0,0,12,0">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <Ellipse Width="8" Height="8" Fill="{Binding StatusColor}"/>
                                                <TextBlock Text="{Binding StatusText}"
                                                           FontSize="12" FontWeight="SemiBold"
                                                           Foreground="{Binding StatusColor}"/>
                                            </StackPanel>
                                        </Border>

                                        <!-- Arrow Icon -->
                                        <FontIcon Grid.Column="3" Glyph="&#xE76C;" FontSize="14"
                                                  Foreground="{StaticResource TextTertiaryBrush}"
                                                  VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Detail Panel (Right Sidebar) - Windows 11 Style with Sensor Icons -->
        <Border Grid.Column="1" Background="{StaticResource BackgroundPrimaryBrush}"
                BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1,0,0,0"
                Width="440"
                Visibility="{x:Bind ViewModel.SelectedNode, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Main Content Area -->
                <Grid Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Sidebar Header - Node Info -->
                    <Border Grid.Row="0" Padding="20,16" BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="0,0,0,1">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Node Icon -->
                            <Border Grid.Column="0"
                                    Background="{StaticResource BackgroundAccentBrush}"
                                    CornerRadius="10" Width="48" Height="48" Margin="0,0,14,0">
                                <FontIcon Glyph="&#xE968;" FontSize="22" Foreground="{StaticResource PrimaryDarkBrush}"
                                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>

                            <!-- Node Title -->
                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                                <TextBlock Text="{x:Bind ViewModel.SelectedNode.NodeName, Mode=OneWay}"
                                           FontSize="17" FontWeight="Bold"
                                           Foreground="{StaticResource TextPrimaryBrush}"
                                           TextTrimming="CharacterEllipsis"/>
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <Ellipse Width="8" Height="8" Fill="{x:Bind ViewModel.SelectedNode.StatusColor, Mode=OneWay}"/>
                                    <TextBlock Text="{x:Bind ViewModel.SelectedNode.StatusText, Mode=OneWay}"
                                               FontSize="13" Foreground="{StaticResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- Close Button -->
                            <Button Grid.Column="2" Style="{StaticResource IconButtonStyle}"
                                    Command="{x:Bind ViewModel.CloseSidebarCommand}" ToolTipService.ToolTip="Đóng">
                                <FontIcon Glyph="&#xE711;" FontSize="12"/>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Tab Navigation -->
                    <Border Grid.Row="1" Padding="12,8" BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="0,0,0,1"
                            Background="{StaticResource BackgroundSecondaryBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Info Tab -->
                            <Button Grid.Column="0" Command="{x:Bind ViewModel.ShowSummaryCommand}"
                                    HorizontalAlignment="Stretch" Padding="8,10" 
                                    Background="{x:Bind ViewModel.IsSidebarSummaryVisible, Mode=OneWay, Converter={StaticResource BoolToAccentBackgroundConverter}}"
                                    BorderThickness="0" CornerRadius="6">
                                <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                    <FontIcon Glyph="&#xE946;" FontSize="14"
                                              Foreground="{x:Bind ViewModel.IsSidebarSummaryVisible, Mode=OneWay, Converter={StaticResource BoolToAccentColorConverter}}"/>
                                    <TextBlock Text="Thông tin" FontSize="13" FontWeight="SemiBold"
                                               Foreground="{x:Bind ViewModel.IsSidebarSummaryVisible, Mode=OneWay, Converter={StaticResource BoolToAccentColorConverter}}"/>
                                </StackPanel>
                            </Button>

                            <!-- Data Tab -->
                            <Button Grid.Column="1" Command="{x:Bind ViewModel.ShowDetailsCommand}"
                                    HorizontalAlignment="Stretch" Padding="8,10" Margin="4,0"
                                    Background="{x:Bind ViewModel.IsSidebarDetailVisible, Mode=OneWay, Converter={StaticResource BoolToAccentBackgroundConverter}}"
                                    BorderThickness="0" CornerRadius="6">
                                <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                    <FontIcon Glyph="&#xE957;" FontSize="14"
                                              Foreground="{x:Bind ViewModel.IsSidebarDetailVisible, Mode=OneWay, Converter={StaticResource BoolToAccentColorConverter}}"/>
                                    <TextBlock Text="Dữ liệu" FontSize="13" FontWeight="SemiBold"
                                               Foreground="{x:Bind ViewModel.IsSidebarDetailVisible, Mode=OneWay, Converter={StaticResource BoolToAccentColorConverter}}"/>
                                </StackPanel>
                            </Button>

                            <!-- Config Tab -->
                            <Button Grid.Column="2" Command="{x:Bind ViewModel.ShowEditCommand}"
                                    HorizontalAlignment="Stretch" Padding="8,10"
                                    Background="{x:Bind ViewModel.IsSidebarEditVisible, Mode=OneWay, Converter={StaticResource BoolToAccentBackgroundConverter}}"
                                    BorderThickness="0" CornerRadius="6">
                                <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                    <FontIcon Glyph="&#xE713;" FontSize="14"
                                              Foreground="{x:Bind ViewModel.IsSidebarEditVisible, Mode=OneWay, Converter={StaticResource BoolToAccentColorConverter}}"/>
                                    <TextBlock Text="Cấu hình" FontSize="13" FontWeight="SemiBold"
                                               Foreground="{x:Bind ViewModel.IsSidebarEditVisible, Mode=OneWay, Converter={StaticResource BoolToAccentColorConverter}}"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Content Area -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <StackPanel Padding="20" Spacing="16">

                            <!-- ===== SUMMARY TAB (Thông tin) ===== -->
                            <StackPanel Visibility="{x:Bind ViewModel.IsSidebarSummaryVisible, Mode=OneWay}">

                                <!-- Node Info (default view when no sensor selected) -->
                                <StackPanel Visibility="{x:Bind ViewModel.SelectedSensor, Mode=OneWay, Converter={StaticResource NullToInverseVisibilityConverter}}"
                                            Spacing="16">
                                    
                                    <!-- Node Overview Header -->
                                    <StackPanel Spacing="8">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Border Grid.Column="0" Background="{StaticResource BackgroundAccentBrush}"
                                                    CornerRadius="8" Width="42" Height="42" Margin="0,0,12,0">
                                                <FontIcon Glyph="&#xE968;" FontSize="20"
                                                          Foreground="{StaticResource PrimaryDarkBrush}"
                                                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                                                <TextBlock Text="Thông tin Node"
                                                           FontSize="16" FontWeight="Bold"
                                                           Foreground="{StaticResource TextPrimaryBrush}"/>
                                                <TextBlock Text="Tổng quan về thiết bị"
                                                           FontSize="12" Foreground="{StaticResource TextTertiaryBrush}"/>
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>

                                    <!-- Node Stats -->
                                    <Border Background="{StaticResource BackgroundAccentBrush}" CornerRadius="12" Padding="20">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0" HorizontalAlignment="Center" Spacing="4">
                                                <TextBlock Text="{x:Bind ViewModel.SelectedNode.Sensors.Count, Mode=OneWay}"
                                                           FontSize="32" FontWeight="Bold" 
                                                           Foreground="{StaticResource PrimaryDarkBrush}" HorizontalAlignment="Center"/>
                                                <TextBlock Text="Cảm biến" FontSize="13"
                                                           Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" HorizontalAlignment="Center" Spacing="4">
                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="4">
                                                    <Ellipse Width="10" Height="10" Fill="{x:Bind ViewModel.SelectedNode.StatusColor, Mode=OneWay}"/>
                                                    <TextBlock Text="{x:Bind ViewModel.SelectedNode.StatusText, Mode=OneWay}"
                                                               FontSize="16" FontWeight="SemiBold" 
                                                               Foreground="{StaticResource PrimaryDarkBrush}"/>
                                                </StackPanel>
                                                <TextBlock Text="Trạng thái" FontSize="13"
                                                           Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>

                                    <!-- Node Details Section -->
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="Chi tiết" FontSize="14" FontWeight="SemiBold"
                                                   Foreground="{StaticResource TextPrimaryBrush}"/>
                                        <Border Background="{StaticResource BackgroundSecondaryBrush}" CornerRadius="10" Padding="14">
                                            <StackPanel Spacing="10">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="Tên Node:" FontSize="13" Foreground="{StaticResource TextTertiaryBrush}" Width="80"/>
                                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.SelectedNode.NodeName, Mode=OneWay}"
                                                               FontSize="13" Foreground="{StaticResource TextPrimaryBrush}" FontWeight="SemiBold"/>
                                                </Grid>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="Tuyến:" FontSize="13" Foreground="{StaticResource TextTertiaryBrush}" Width="80"/>
                                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.SelectedNode.LineName, Mode=OneWay}"
                                                               FontSize="13" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                </Grid>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="Vị trí:" FontSize="13" Foreground="{StaticResource TextTertiaryBrush}" Width="80"/>
                                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.SelectedNode.Location, Mode=OneWay}"
                                                               FontSize="13" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                </Grid>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>

                                    <!-- Sensors List Preview -->
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="Danh sách cảm biến" FontSize="14" FontWeight="SemiBold"
                                                   Foreground="{StaticResource TextPrimaryBrush}"/>
                                        <TextBlock Text="Nhấn vào icon cảm biến bên phải để xem chi tiết" FontSize="12"
                                                   Foreground="{StaticResource TextTertiaryBrush}"/>
                                    </StackPanel>
                                </StackPanel>

                                <!-- Sensor Info (when sensor is selected) -->
                                <StackPanel Visibility="{x:Bind ViewModel.SelectedSensor, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}" Spacing="16">
                                    
                                    <!-- Sensor Header -->
                                    <StackPanel Spacing="8">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Border Grid.Column="0" Background="{StaticResource BackgroundAccentBrush}"
                                                    CornerRadius="8" Width="42" Height="42" Margin="0,0,12,0">
                                                <FontIcon Glyph="{x:Bind ViewModel.SelectedSensor.TypeIcon, Mode=OneWay}" FontSize="20"
                                                          Foreground="{StaticResource PrimaryDarkBrush}"
                                                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                                                <TextBlock Text="{x:Bind ViewModel.SelectedSensor.SensorName, Mode=OneWay}"
                                                           FontSize="16" FontWeight="Bold"
                                                           Foreground="{StaticResource TextPrimaryBrush}" TextWrapping="Wrap"/>
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <TextBlock Text="{x:Bind ViewModel.SelectedSensor.SensorType, Mode=OneWay}"
                                                               FontSize="12" Foreground="{StaticResource TextTertiaryBrush}"/>
                                                    <Ellipse Width="6" Height="6" Fill="{x:Bind ViewModel.SelectedSensor.SensorStatusColor, Mode=OneWay}" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>

                                    <!-- Current Value Display -->
                                    <Border Background="{StaticResource BackgroundAccentBrush}" CornerRadius="12" Padding="20">
                                        <StackPanel HorizontalAlignment="Center" Spacing="6">
                                            <TextBlock FontSize="36" FontWeight="Bold" Foreground="{StaticResource PrimaryDarkBrush}" HorizontalAlignment="Center">
                                                <Run Text="{x:Bind ViewModel.SelectedSensor.CurrentValue, Mode=OneWay}"/>
                                                <Run Text=" "/>
                                                <Run Text="{x:Bind ViewModel.SelectedSensor.Unit, Mode=OneWay}" FontSize="18"/>
                                            </TextBlock>
                                            <TextBlock FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center">
                                                <Run Text="Cập nhật: "/>
                                                <Run Text="{x:Bind ViewModel.SelectedSensor.LastUpdateText, Mode=OneWay}"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>

                                    <!-- Sensor Info Section -->
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="Thông tin" FontSize="14" FontWeight="SemiBold"
                                                   Foreground="{StaticResource TextPrimaryBrush}"/>
                                        <Border Background="{StaticResource BackgroundSecondaryBrush}" CornerRadius="10" Padding="14">
                                            <StackPanel Spacing="10">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="ID:" FontSize="13" Foreground="{StaticResource TextTertiaryBrush}" Width="70"/>
                                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.SelectedSensor.SensorId, Mode=OneWay}"
                                                               FontSize="13" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                </Grid>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="Tuyến:" FontSize="13" Foreground="{StaticResource TextTertiaryBrush}" Width="70"/>
                                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.SelectedSensor.LineName, Mode=OneWay}"
                                                               FontSize="13" Foreground="{StaticResource TextPrimaryBrush}" FontWeight="SemiBold"/>
                                                </Grid>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="Vị trí:" FontSize="13" Foreground="{StaticResource TextTertiaryBrush}" Width="70"/>
                                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.SelectedSensor.Location, Mode=OneWay}"
                                                               FontSize="13" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                </Grid>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </StackPanel>

                            </StackPanel>

                            <!-- ===== DATA TAB (Dữ liệu) ===== -->
                            <StackPanel Visibility="{x:Bind ViewModel.IsSidebarDetailVisible, Mode=OneWay}" Spacing="16">
                                
                                <StackPanel Spacing="8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Border Grid.Column="0" Background="{StaticResource BackgroundAccentBrush}"
                                                CornerRadius="8" Width="42" Height="42" Margin="0,0,12,0">
                                            <FontIcon Glyph="&#xE957;" FontSize="20"
                                                      Foreground="{StaticResource PrimaryDarkBrush}"
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                                            <TextBlock Text="Dữ liệu cảm biến"
                                                       FontSize="16" FontWeight="Bold"
                                                       Foreground="{StaticResource TextPrimaryBrush}"/>
                                            <TextBlock Text="Lịch sử đo và biểu đồ"
                                                       FontSize="12" Foreground="{StaticResource TextTertiaryBrush}"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>

                                <!-- Placeholder for chart/data -->
                                <Border Background="{StaticResource BackgroundSecondaryBrush}" CornerRadius="10" Padding="20" MinHeight="200">
                                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="12">
                                        <FontIcon Glyph="&#xE9D9;" FontSize="36" Foreground="{StaticResource TextTertiaryBrush}"/>
                                        <TextBlock Text="Biểu đồ dữ liệu" FontSize="14" Foreground="{StaticResource TextSecondaryBrush}"/>
                                        <TextBlock Text="Sẽ hiển thị lịch sử đo của cảm biến được chọn" FontSize="12" 
                                                   Foreground="{StaticResource TextTertiaryBrush}" TextAlignment="Center"/>
                                    </StackPanel>
                                </Border>

                            </StackPanel>

                            <!-- ===== CONFIG TAB (Cấu hình) ===== -->
                            <StackPanel Visibility="{x:Bind ViewModel.IsSidebarEditVisible, Mode=OneWay}" Spacing="16">
                                
                                <StackPanel Spacing="8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Border Grid.Column="0" Background="{StaticResource BackgroundAccentBrush}"
                                                CornerRadius="8" Width="42" Height="42" Margin="0,0,12,0">
                                            <FontIcon Glyph="&#xE713;" FontSize="20"
                                                      Foreground="{StaticResource PrimaryDarkBrush}"
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                                            <TextBlock Text="Cấu hình thiết bị"
                                                       FontSize="16" FontWeight="Bold"
                                                       Foreground="{StaticResource TextPrimaryBrush}"/>
                                            <TextBlock Text="Cài đặt và tham số"
                                                       FontSize="12" Foreground="{StaticResource TextTertiaryBrush}"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>

                                <!-- Config options -->
                                <Border Background="{StaticResource BackgroundSecondaryBrush}" CornerRadius="10" Padding="14">
                                    <StackPanel Spacing="12">
                                        <TextBlock Text="Cài đặt chung" FontSize="14" FontWeight="SemiBold" Foreground="{StaticResource TextPrimaryBrush}"/>
                                        
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Tần suất cập nhật" FontSize="13" Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="1" Width="120" SelectedIndex="1">
                                                <ComboBoxItem>5 giây</ComboBoxItem>
                                                <ComboBoxItem>10 giây</ComboBoxItem>
                                                <ComboBoxItem>30 giây</ComboBoxItem>
                                                <ComboBoxItem>1 phút</ComboBoxItem>
                                            </ComboBox>
                                        </Grid>

                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Thông báo cảnh báo" FontSize="13" Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                            <ToggleSwitch Grid.Column="1" IsOn="True" OnContent="" OffContent=""/>
                                        </Grid>
                                    </StackPanel>
                                </Border>

                                <!-- Actions -->
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Button Grid.Column="0" Margin="0,0,4,0"
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            HorizontalAlignment="Stretch">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <FontIcon Glyph="&#xE72C;" FontSize="12"/>
                                            <TextBlock Text="Làm mới" FontSize="13"/>
                                        </StackPanel>
                                    </Button>

                                    <Button Grid.Column="1" Margin="4,0,0,0"
                                            Style="{StaticResource PrimaryButtonStyle}"
                                            HorizontalAlignment="Stretch">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <FontIcon Glyph="&#xE74E;" FontSize="12"/>
                                            <TextBlock Text="Lưu" FontSize="13"/>
                                        </StackPanel>
                                    </Button>
                                </Grid>

                            </StackPanel>

                        </StackPanel>
                    </ScrollViewer>
                </Grid>

                <!-- Vertical Icons Toolbar (Right Side) - Windows 11 Style -->
                <Border Grid.Column="1" Background="{StaticResource BackgroundSecondaryBrush}"
                        BorderBrush="{StaticResource BorderLightBrush}" BorderThickness="1,0,0,0"
                        Width="60">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,12,0,12" Spacing="6">
                            
                            <!-- Node Icon (Show Node Info) -->
                            <Button Width="44" Height="44" CornerRadius="8" Padding="0"
                                    HorizontalAlignment="Center"
                                    Background="{StaticResource BackgroundAccentBrush}"
                                    ToolTipService.ToolTip="Thông tin Node"
                                    Tapped="NodeIcon_Tapped">
                                <FontIcon Glyph="&#xE968;" FontSize="18"
                                          Foreground="{StaticResource PrimaryDarkBrush}"/>
                            </Button>
                            
                            <!-- Separator -->
                            <Border Height="1" Width="36" Background="{StaticResource BorderLightBrush}" 
                                    HorizontalAlignment="Center" Margin="0,4"/>
                            
                            <!-- Sensor Icons -->
                            <ItemsRepeater ItemsSource="{x:Bind ViewModel.SelectedNode.Sensors, Mode=OneWay}">
                                <ItemsRepeater.Layout>
                                    <StackLayout Spacing="6" Orientation="Vertical"/>
                                </ItemsRepeater.Layout>
                                <ItemsRepeater.ItemTemplate>
                                    <DataTemplate>
                                        <Button Width="44" Height="44" CornerRadius="8" Padding="0"
                                                HorizontalAlignment="Center"
                                                Background="Transparent"
                                                ToolTipService.ToolTip="{Binding SensorName}"
                                                Tapped="SensorIcon_Tapped">
                                            <FontIcon Glyph="{Binding TypeIcon}" FontSize="18"
                                                      Foreground="{StaticResource TextSecondaryBrush}"/>
                                        </Button>
                                    </DataTemplate>
                                </ItemsRepeater.ItemTemplate>
                            </ItemsRepeater>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Page>